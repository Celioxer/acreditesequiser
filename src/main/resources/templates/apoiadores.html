<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/head :: common_head('Bem-vindo, Apoiador!')}"></head>

<body>
<div class="sticky-footer-layout">

    <div th:replace="~{fragments/header :: header}"></div>

    <main class="welcome-page-container">
        <div class="welcome-card">

            <div sec:authorize="isAuthenticated()">
                <h1 class="welcome-greeting">
                    Obrigado pelo seu apoio, <span th:text="${#authentication.principal.username}">Usu√°rio</span>!
                </h1>
            </div>

            <p class="welcome-subtitle">
                Sua contribui√ß√£o √© fundamental para continuarmos nossa explora√ß√£o dos maiores mist√©rios do universo. Agora, voc√™ faz parte do c√≠rculo interno de investigadores.
            </p>

            <div class="subscription-validity">
                <!-- Verifica se √© SUBSCRIBER (ou j√° foi) e se possui data de validade -->
                <div th:if="${usuario.role.name() == 'SUBSCRIBER' and usuario.acessoValidoAte != null}">
                    <th:block th:with="diasParaVencimento=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), T(java.time.LocalDate).from(usuario.acessoValidoAte))}">

                        <!-- CONTE√öDO DA RENOVA√á√ÉO: SEMPRE VIS√çVEL PARA O ASSINANTE -->
                        <div class="renewal-cta-container">
                            <hr class="welcome-divider">

                            <!-- MENSAGEM DE ALERTA (S√≥ aparece se estiver perto de vencer ou vencido) -->
                            <div th:if="${diasParaVencimento <= 10 or diasParaVencimento < 0}">
                                <p th:if="${diasParaVencimento >= 0}" class="text-danger font-weight-bold">
                                    üö® Seu acesso vence em <span th:text="${diasParaVencimento}">X</span> dias! Renove agora e garanta a continuidade.
                                </p>
                                <p th:if="${diasParaVencimento < 0}" class="text-danger font-weight-bold">
                                    üö´ Seu acesso **venceu h√° <span th:text="${-diasParaVencimento}">X</span> dias!** Pague agora para reativar.
                                </p>
                            </div>

                            <!-- MENSAGEM DE CONFORTO (Aparece se estiver ativo e longe do vencimento) -->
                            <p th:if="${diasParaVencimento > 10}" class="text-success font-weight-bold">
                                ‚úÖ Sua assinatura est√° ativa at√© <span th:text="${#temporals.format(usuario.acessoValidoAte, 'dd/MM/yyyy')}"></span>. Voc√™ pode renovar antecipadamente a qualquer momento!
                            </p>

                            <!-- FORMUL√ÅRIO DE RENOVA√á√ÉO (AGORA SEMPRE VIS√çVEL) -->
                            <!-- O th:if que restringia a visualiza√ß√£o foi removido. -->
                            <form th:action="@{/assinatura/renovar}" method="GET" class="mt-3">
                                <div class="form-group">
                                    <label for="valorRenovacao">Escolha o valor do seu apoio (m√≠nimo R$ 10,00):</label>
                                    <input type="number" step="0.01" min="10.00" class="form-control" id="valorRenovacao" name="valor" value="10.00" required>
                                </div>

                                <p class="mt-3">Escolha o m√©todo de pagamento:</p>
                                <div class="btn-group btn-block" role="group" aria-label="M√©todo de Pagamento">
                                    <button type="submit" name="paymentMethod" value="pix" class="btn btn-warning">
                                        <i class="fas fa-qrcode"></i> Renovar com PIX
                                    </button>
                                    <button type="submit" name="paymentMethod" value="card" class="btn btn-primary">
                                        <i class="fas fa-credit-card"></i> Renovar com Cart√£o
                                    </button>
                                </div>
                            </form>
                        </div>

                    </th:block>
                </div>
            </div>

            <hr class="welcome-divider">

            <!-- BLOCO DE SEGURAN√áA: WHATSAPP -->
            <!-- S√≥ exibe se o usu√°rio for SUBSCRIBER E a data de validade for MAIOR que agora -->
            <div class="welcome-cta"
                 th:if="${usuario.role.name() == 'SUBSCRIBER' and usuario.acessoValidoAte != null and usuario.acessoValidoAte.isAfter(#temporals.createNow())}">
                <h2><i class="fab fa-whatsapp"></i> Acesso ao Grupo Secreto</h2>
                <p>Conecte-se com outros apoiadores, discuta teorias e receba novidades em primeira m√£o no nosso grupo exclusivo para membros.</p>
                <a href="https://chat.whatsapp.com/JnF3abEIx336wmD4M9s7Jy" target="_blank" class="btn btn-whatsapp">Entrar no Grupo</a>
            </div>

            <!-- BLOCO DE SEGURAN√áA: EPIS√ìDIOS -->
            <!-- Mesma regra de seguran√ßa -->
            <div class="welcome-cta"
                 th:if="${usuario.role.name() == 'SUBSCRIBER' and usuario.acessoValidoAte != null and usuario.acessoValidoAte.isAfter(#temporals.createNow())}">
                <h2><i class="fas fa-play-circle"></i> Explore os Arquivos</h2>
                <p>Todo o nosso acervo de epis√≥dios, incluindo o conte√∫do exclusivo para assinantes, est√° liberado para voc√™. Comece sua maratona agora mesmo.</p>
                <a th:href="@{/episodios}" class="btn btn-episodios">Acessar Epis√≥dios</a>
            </div>

            <!-- Mensagem para quem N√ÉO tem acesso ativo -->
            <div class="alert alert-warning text-center"
                 th:unless="${usuario.role.name() == 'SUBSCRIBER' and usuario.acessoValidoAte != null and usuario.acessoValidoAte.isAfter(#temporals.createNow())}">
                <h4>üîí Conte√∫do Bloqueado</h4>
                <p>Para acessar o Grupo VIP e os Epis√≥dios Exclusivos, sua assinatura precisa estar ativa.</p>
                <p>Se voc√™ j√° pagou, aguarde a confirma√ß√£o ou renove sua assinatura acima.</p>
            </div>

        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script th:src="@{/js/script.js}" defer></script>
</body>
</html>