<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Pagamento com Cartão</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        body.auth-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .payment-container { width: 100%; max-width: 450px; padding: 30px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); text-align: center; border: 1px solid #ddd; }
        .payment-container h2 { font-size: 1.8rem; color: #333; margin-bottom: 10px; }
        .payment-summary { color: #555; margin-bottom: 25px; }
        form div.form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        .input-mp, .input-std { width: 100%; height: 45px; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; font-size: 1rem; box-sizing: border-box; }
        select.input-std { padding: 0 10px; }
        #form-checkout__submit { width: 100%; padding: 12px; background-color: #009ee3; color: #fff; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; margin-top: 15px; }
    </style>
</head>
<body class="auth-page">

<div class="payment-container">
    <h2>Pagamento com Cartão</h2>
    <p class="payment-summary">
        Você está apoiando com <strong th:text="${'R$ ' + #numbers.formatDecimal(valor, 1, 'POINT', 2, 'COMMA')}">R$ 10,00</strong>.
    </p>

    <form id="form-checkout">
        <div class="form-group"><label for="cardNumber">Número do Cartão</label><div id="cardNumber" class="input-mp"></div></div>
        <div class="form-group"><label for="cardExpirationDate">Data de Vencimento</label><div id="cardExpirationDate" class="input-mp"></div></div>
        <div class="form-group"><label for="securityCode">Código de Segurança (CVV)</label><div id="securityCode" class="input-mp"></div></div>
        <div class="form-group"><label for="installments">Parcelas</label><div id="installments" class="input-mp"></div></div>
        <div class="form-group"><label for="cardholderName">Nome do Titular</label><input type="text" id="cardholderName" class="input-std" /></div>
        <div class="form-group"><label for="cardholderEmail">E-mail</label><input type="email" id="cardholderEmail" class="input-std" /></div>
        <div class="form-group"><label for="identificationType">Tipo de documento</label><select id="identificationType" class="input-std"></select></div>
        <div class="form-group"><label for="identificationNumber">Número do documento</label><input type="text" id="identificationNumber" class="input-std" /></div>
        <button type="submit" id="form-checkout__submit">Pagar</button>
    </form>
</div>

<script th:inline="javascript">
    const valorPagamento = /*[[${valor}]]*/ '10.00';
    const descricaoPagamento = /*[[${descricao}]]*/ 'Apoio Mensal';

    // <<< VERIFIQUE SE ESTA CHAVE É EXATAMENTE IGUAL À SUA PUBLIC KEY DE TESTE NO PAINEL MP >>>
    const publicKey = 'APP_USR-7096982883387042-082007-1d72c0c0f8ce2f421e0ef79d89127968-4764188';

    const mp = new MercadoPago(publicKey, { locale: 'pt-BR' });

    const cardForm = mp.cardForm({
        amount: valorPagamento.toString(),
        iframe: true,
        form: {
            id: "form-checkout",
            cardNumber: { id: "cardNumber", placeholder: "0000 0000 0000 0000" },
            cardExpirationDate: { id: "cardExpirationDate", placeholder: "MM/AA" },
            securityCode: { id: "securityCode", placeholder: "CVV" },
            installments: { id: "installments", placeholder: "Selecione" },
            cardholderName: { id: "cardholderName", placeholder: "Nome como no cartão" },
            cardholderEmail: { id: "cardholderEmail", placeholder: "seu@email.com" },
            identificationType: { id: "identificationType" },
            identificationNumber: { id: "identificationNumber", placeholder: "Seu documento" }
        },
        callbacks: {
            onFormMounted: error => {
                if (error) return console.warn("Erro ao montar o formulário:", error);
            },
            onSubmit: event => {
                event.preventDefault();
                const submitButton = document.getElementById('form-checkout__submit');
                submitButton.disabled = true;

                const { token, installments } = cardForm.getCardFormData();

                fetch("/process-card-payment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        token: token,
                        valor: valorPagamento.toString(),
                        descricao: descricaoPagamento,
                        installments: installments
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.redirectUrl) {
                        window.location.href = data.redirectUrl;
                    } else {
                        alert("Erro no pagamento: " + (data.error || "Tente novamente."));
                        submitButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Erro na requisição:", error);
                    alert("Ocorreu um erro ao processar o pagamento.");
                    submitButton.disabled = false;
                });
            },
            onError: (errors) => {
                console.error("Erros de validação do formulário:", errors);
                const firstError = errors[0] || {};
                alert("Por favor, corrija os erros no formulário: " + (firstError.message || "Dados inválidos."));
            },
        },
    });
</script>

</body>
</html>