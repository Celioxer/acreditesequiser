<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Pagamento com Cartão</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <style>
        body.auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-color: #f5f5f5;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .payment-container {
            width: 100%;
            max-width: 450px;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid #ddd;
        }
        .payment-container h2 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 10px;
        }
        .payment-summary {
            color: #555;
            margin-bottom: 25px;
        }
        form div.form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        .input-mp {
            width: 100%;
            height: 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0 10px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: white;
        }
        .input-std {
            width: 100%;
            height: 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0 10px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        select.input-std {
            padding: 0 10px;
        }
        #form-checkout__submit {
            width: 100%;
            padding: 12px;
            background-color: #009ee3;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px;
        }
        #form-checkout__submit:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="auth-page">

<div class="payment-container">
    <h2>Pagamento com Cartão</h2>
    <p class="payment-summary">
        Você está apoiando com <strong th:text="${'R$ ' + #numbers.formatDecimal(valor, 1, 'POINT', 2, 'COMMA')}">R$ 10,00</strong>.
    </p>

    <form id="form-checkout">
        <div class="form-group">
            <label for="form-checkout__cardNumber">Número do Cartão</label>
            <div id="form-checkout__cardNumber" class="input-mp"></div>
        </div>
        <input type="hidden" name="deviceId" id="deviceId" />
        <div class="form-group">
            <label for="form-checkout__expirationDate">Data de Vencimento</label>
            <div id="form-checkout__expirationDate" class="input-mp"></div>
        </div>
        <div class="form-group">
            <label for="form-checkout__securityCode">Código de Segurança (CVV)</label>
            <div id="form-checkout__securityCode" class="input-mp"></div>
        </div>
        <div class="form-group">
            <label for="form-checkout__installments">Parcelas</label>
            <select id="form-checkout__installments" class="input-std"></select>
        </div>
        <div class="form-group">
            <label for="form-checkout__issuer">Banco emissor</label>
            <select id="form-checkout__issuer" class="input-std"></select>
        </div>
        <div class="form-group">
            <label for="form-checkout__cardholderName">Nome do Titular</label>
            <input type="text" id="form-checkout__cardholderName" class="input-std" />
        </div>
        <div class="form-group">
            <label for="form-checkout__cardholderEmail">E-mail</label>
            <input type="email" id="form-checkout__cardholderEmail" class="input-std" />
        </div>
        <div class="form-group">
            <label for="form-checkout__identificationType">Tipo de documento</label>
            <select id="form-checkout__identificationType" class="input-std"></select>
        </div>
        <div class="form-group">
            <label for="form-checkout__identificationNumber">Número do documento</label>
            <input type="text" id="form-checkout__identificationNumber" class="input-std" />
        </div>
        <button type="submit" id="form-checkout__submit">Pagar</button>
    </form>
</div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
    (function() {
        var script = document.createElement("script");
        script.src = "https://www.mercadopago.com/v2/security.js";
        script.setAttribute("view", "checkout");
        script.onload = function() {
            var deviceId = window.MP_DEVICE_SESSION_ID;
            if (deviceId) {
                document.getElementById("deviceId").value = deviceId;
            }
        };
        document.body.appendChild(script);
    })();
</script>
<script th:inline="javascript">
    // Variáveis do Thymeleaf
    const valorPagamento = [[${valor}]];
    const descricaoPagamento = [[${descricao}]];
    const publicKey = 'APP_USR-6b43d260-2d40-4a94-807d-80a43ee05a7c'; // Lembre-se de trocar para a Chave de Produção

    console.log('Inicializando Mercado Pago com valor:', valorPagamento);

    const mp = new MercadoPago(publicKey, { locale: 'pt-BR' });

    const cardForm = mp.cardForm({
        amount: valorPagamento.toString(),
        iframe: true,
        form: {
            id: "form-checkout",
            cardNumber: { id: "form-checkout__cardNumber", placeholder: "Número do cartão" },
            expirationDate: { id: "form-checkout__expirationDate", placeholder: "MM/AA" },
            securityCode: { id: "form-checkout__securityCode", placeholder: "CVV" },
            installments: { id: "form-checkout__installments", placeholder: "Parcelas" },
            issuer: { id: "form-checkout__issuer", placeholder: "Banco emissor" },
            cardholderName: { id: "form-checkout__cardholderName", placeholder: "Nome do Titular" },
            cardholderEmail: { id: "form-checkout__cardholderEmail", placeholder: "E-mail" },
            identificationType: { id: "form-checkout__identificationType", placeholder: "Tipo de documento" },
            identificationNumber: { id: "form-checkout__identificationNumber", placeholder: "Número do documento" },
        },
        callbacks: {
            onFormMounted: error => {
                if (error) return console.warn("Falha ao montar o formulário:", error);
                console.log("Formulário montado com sucesso.");
            },

            // --- INÍCIO DO CÓDIGO CORRIGIDO ---
            onSubmit: event => {
                event.preventDefault();
                const submitButton = document.getElementById('form-checkout__submit');
                submitButton.disabled = true;
                document.getElementById('form-checkout').classList.add('loading');

                const {
                    paymentMethodId,
                    token,
                    installments,
                    issuerId,
                } = cardForm.getCardFormData();

                fetch("/process-card-payment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        token: token,
                        paymentMethodId: paymentMethodId,
                        installments: Number(installments),
                        issuerId: Number(issuerId),
                        valor: valorPagamento.toString(),
                        descricao: descricaoPagamento,
                        payer: {
                            email: document.getElementById('form-checkout__cardholderEmail').value,
                            identification: {
                                type: document.getElementById('form-checkout__identificationType').value,
                                number: document.getElementById('form-checkout__identificationNumber').value
                            }
                         }
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw errorData;
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Resposta da criação da assinatura:", data);

                    if (data.status === 'authorized') {
                        window.location.href = '/pagamento-sucesso';
                    } else if (data.status === 'in_process' || data.status === 'pending') {
                        window.location.href = '/payment-pending';
                    } else {
                        // Tenta pegar a causa do erro, se disponível
                        let message = 'Falha ao criar assinatura.';
                        if (data.message) {
                            message = data.message;
                        } else if (data.cause && data.cause.length > 0 && data.cause[0].description) {
                            message = data.cause[0].description;
                        }
                        throw new Error(message);
                    }
                })
                .catch(error => {
                    console.error("Erro ao processar pagamento:", error);
                    let errorMessage = "Ocorreu um erro desconhecido.";
                    if (error.message) {
                        errorMessage = error.message;
                    } else if (error.error) {
                        errorMessage = error.error;
                    }

                    alert("Erro: " + errorMessage);
                    submitButton.disabled = false;
                    document.getElementById('form-checkout').classList.remove('loading');
                });
            }, // <-- A VÍRGULA AQUI É IMPORTANTE

            // --- FIM DO CÓDIGO CORRIGIDO ---

            // ESTE BLOCO 'onError' ESTAVA FALTANDO NO SEU ÚLTIMO CÓDIGO
            onError: (errors) => {
                console.error("Erros de validação:", errors);
                const errorMessages = errors.map(error => error.message).join('\n');
                alert("Corrija os seguintes erros:\n" + errorMessages);
            },
        }, // Fim do callbacks
    }); // Fim do cardForm
</script>
</body>
</html>