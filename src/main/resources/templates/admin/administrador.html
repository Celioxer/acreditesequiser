<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Administrador</title>

    <link rel="stylesheet" th:href="@{/css/style.css(v=${@environment.getProperty('app.version')})}">

    <style>
        /* Estilos gerais para a p√°gina de admin que sobrescrevem o style.css */
        .admin-page-container h1, .admin-page-container h2 {
            color: #BE93FD;
            border-bottom: 1px solid #3d2c4b;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .card {
            background-color: #1d2a2d;
            border: 1px solid #3d2c4b !important;
        }
        .card h3 {
             color: #BE93FD;
        }
        .card p {
            color: #D6C178;
        }

        /* Estilos para os filtros e pesquisa */
        .admin-controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .admin-controls label { font-weight: normal; color: #ccc; }
        .admin-controls input, .admin-controls select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #3d2c4b;
            background-color: #1d2a2d;
            color: #D6C178;
            font-size: 1em;
        }

        /* Estilo para a tabela */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.95em;
            border: 1px solid #3d2c4b;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
        }
        .admin-table thead tr {
            background-color: #0A1517;
            color: #BE93FD;
            text-align: left;
            font-weight: bold;
        }
        .admin-table th, .admin-table td {
            padding: 12px 15px;
            border: 1px solid #3d2c4b;
            vertical-align: middle;
        }
        .admin-table tbody tr {
            background-color: #1d2a2d;
            border-bottom: 1px solid #3d2c4b;
        }
        .admin-table tbody tr:nth-of-type(even) {
            background-color: #2a3c40;
        }
        .admin-table tbody tr:hover {
            background-color: #3c565c;
            color: #ffffff;
        }
        .admin-table button, .admin-table input, .admin-table select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #3C8F9E;
            background-color: #0D1B1E;
            color: #D6C178;
            cursor: pointer;
        }
        .admin-table button:hover {
            background-color: #3C8F9E;
            color: #fff;
        }
        .admin-table input[type="date"] { width: auto; }

        /* Estilos do Sorteio */
        .raffle-container { margin-top: 40px; padding: 20px; border: 1px solid #3d2c4b; border-radius: 8px; text-align: center; background-color: #1d2a2d; }
        .raffle-container h2 { border: none; }
        .winner-card { display: none; margin-top: 20px; padding: 20px; background-color: #2a403d; border: 1px solid #D6C178; color: #D6C178; border-radius: 8px; animation: fadeIn 0.5s; }
        .winner-card h3 { margin-top: 0; }
        #draw-button { padding: 10px 20px; font-size: 1.2em; cursor: pointer; background-color: #3C8F9E; color: white; border: none; border-radius: 5px; }
        #draw-button:disabled { background-color: #555; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body>
<div class="sticky-footer-layout">
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="admin-page-container" style="padding: 20px; max-width: 1400px; margin: auto;">
        <h1>Painel do Administrador</h1>

        <div class="dashboard" style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div class="card" style="padding: 20px; border-radius: 8px;">
                <h3>Apoiadores Ativos</h3>
                <p id="total-pagantes" style="font-size: 2em; margin: 0;">Carregando...</p>
            </div>
        </div>

        <h2>Gerenciamento de Usu√°rios</h2>

        <div class="admin-controls">
            <div>
                <label for="status-filter">Filtrar por Status:</label>
                <select id="status-filter">
                    <option value="">Todos</option>
                    <option value="ATIVO">Ativos</option>
                    <option value="EXPIRADO">Expirados</option>
                    <option value="NUNCA_PAGOU">Nunca Pagou</option>
                </select>
            </div>
            <div>
                <label for="search-input">Pesquisar:</label>
                <input type="text" id="search-input" placeholder="Nome ou E-mail...">
            </div>
        </div>

        <table class="admin-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Status</th>
                <th>Vencimento</th>
                <th>Gerenciar Assinatura</th>
                <th>Papel (Role)</th>
                <th>A√ß√µes</th>
            </tr>
            </thead>
            <tbody id="user-table-body">
            </tbody>
        </table>

        <div class="raffle-container">
            <h2>Sorteio de Apoiadores Ativos</h2>
            <p>Clique no bot√£o abaixo para sortear aleatoriamente um apoiador com assinatura ativa.</p>
            <button id="draw-button">Sortear um Ganhador</button>
            <div id="winner-display" class="winner-card">
                <h3>üéâ O Ganhador √©... üéâ</h3>
                <p style="font-size: 1.5em; font-weight: bold;" id="winner-name"></p>
                <p style="color: #555;" id="winner-email"></p>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchDashboardData();
        fetchUsers();

        document.getElementById('status-filter').addEventListener('change', fetchUsers);
        document.getElementById('search-input').addEventListener('keyup', fetchUsers);
        document.getElementById('draw-button').addEventListener('click', drawWinner);
    });

    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard');
            const data = await response.json();
            document.getElementById('total-pagantes').textContent = data.totalPagantesAtivos;
        } catch (error) {
            console.error('Erro ao buscar dados do dashboard:', error);
            document.getElementById('total-pagantes').textContent = 'Erro!';
        }
    }

    async function fetchUsers() {
        const status = document.getElementById('status-filter').value;
        const search = document.getElementById('search-input').value;
        const url = `/api/admin/users?status=${status}&search=${search}`;

        try {
            const response = await fetch(url);
            if (!response.ok) { throw new Error(`Erro na API: ${response.status}`); }
            const users = await response.json();
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';

            if (users.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="9">Nenhum usu√°rio encontrado.</td></tr>';
                 return;
            }

            users.forEach(user => {
                const vencimento = user.acessoValidoAte ? new Date(user.acessoValidoAte).toLocaleDateString('pt-BR') : 'N/A';
                const hoje = new Date().toISOString().split('T')[0];

                let subscriptionControls = '';
                if (user.role !== 'ADMIN') {
                    subscriptionControls = `
                        <input type="date" id="date-input-${user.id}" min="${hoje}" style="padding: 4px;">
                        <button onclick="setSubscriptionDate(${user.id})">Definir Vencimento</button>
                    `;
                }

                const row = `
                    <tr>
                        <td><b>${user.id}</b></td>
                        <td>${user.nome}</td>
                        <td>${user.email}</td>
                        <td>${user.telefone || 'N/A'}</td>
                        <td><b>${user.status}</b></td>
                        <td>${vencimento}</td>
                        <td>${subscriptionControls}</td>
                        <td>
                            <select id="role-select-${user.id}">
                                <option value="USER" ${user.role === 'USER' ? 'selected' : ''}>USER</option>
                                <option value="SUBSCRIBER" ${user.role === 'SUBSCRIBER' ? 'selected' : ''}>SUBSCRIBER</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                            </select>
                        </td>
                        <td>
                            <button onclick="updateRole(${user.id})">Salvar Papel</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error('Erro ao buscar usu√°rios:', error);
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = `<tr><td colspan="9" style="color: red;">Falha ao carregar usu√°rios.</td></tr>`;
        }
    }

    async function updateRole(userId) {
        const select = document.getElementById(`role-select-${userId}`);
        const newRole = select.value;

        if (!confirm(`Tem certeza que deseja alterar o papel deste usu√°rio para ${newRole}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/role`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: newRole })
            });
            if (response.ok) { alert('Papel atualizado!'); fetchUsers(); }
            else { alert('Falha ao atualizar o papel.'); }
        } catch (error) { console.error('Erro:', error); }
    }

    async function setSubscriptionDate(userId) {
        const input = document.getElementById(`date-input-${userId}`);
        const newDate = input.value;

        if (!newDate) {
            alert('Por favor, selecione uma data de vencimento.');
            return;
        }

        if (!confirm(`Tem certeza que deseja definir o vencimento para ${new Date(newDate).toLocaleDateString('pt-BR')}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/subscription/set-date`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newExpirationDate: newDate })
            });

            if (response.ok) {
                alert('Data de vencimento atualizada com sucesso!');
                fetchUsers();
            } else {
                alert('Falha ao atualizar a data. Verifique o console.');
            }
        } catch (error) {
            console.error('Erro ao definir data de vencimento:', error);
        }
    }

    async function drawWinner() {
        const drawButton = document.getElementById('draw-button');
        const winnerDisplay = document.getElementById('winner-display');
        const winnerName = document.getElementById('winner-name');
        const winnerEmail = document.getElementById('winner-email');

        drawButton.disabled = true;
        drawButton.textContent = 'Sorteando...';
        winnerDisplay.style.display = 'none';

        try {
            const response = await fetch('/api/admin/raffle/draw');
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (response.ok) {
                const winner = await response.json();
                winnerName.textContent = winner.nome;
                winnerEmail.textContent = winner.email;
                winnerDisplay.style.display = 'block';
            } else if (response.status === 404) {
                winnerName.textContent = 'N√£o h√° apoiadores ativos para o sorteio.';
                winnerEmail.textContent = '';
                winnerDisplay.style.display = 'block';
            } else {
                throw new Error('Falha ao realizar o sorteio.');
            }
        } catch (error) {
            console.error('Erro no sorteio:', error);
            alert('Ocorreu um erro ao realizar o sorteio. Verifique o console.');
        } finally {
            drawButton.disabled = false;
            drawButton.textContent = 'Sortear Novo Ganhador';
        }
    }

</script>
</body>
</html>