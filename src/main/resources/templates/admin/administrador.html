<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Administrador</title>
    <link rel="stylesheet" th:href="@{/css/style.css(v=${@environment.getProperty('app.version')})}">
    <style>
        /* Estilos gerais para a p√°gina de admin */
        .admin-page-container h1, .admin-page-container h2 { color: #BE93FD; border-bottom: 1px solid #3d2c4b; padding-bottom: 10px; margin-bottom: 20px; }
        .card { background-color: #1d2a2d; border: 1px solid #3d2c4b !important; }
        .card h3 { color: #BE93FD; }
        .card p { color: #D6C178; }
        .admin-controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .admin-controls label { font-weight: normal; color: #ccc; }
        .admin-controls input, .admin-controls select { padding: 10px; border-radius: 5px; border: 1px solid #3d2c4b; background-color: #1d2a2d; color: #D6C178; font-size: 1em; }
        .admin-table { width: 100%; border-collapse: collapse; margin: 25px 0; font-size: 0.95em; border: 1px solid #3d2c4b; border-radius: 8px; overflow: hidden; box-shadow: 0 0 20px rgba(0, 0, 0, 0.25); }
        .admin-table thead tr { background-color: #0A1517; color: #BE93FD; text-align: left; font-weight: bold; }
        .admin-table th, .admin-table td { padding: 12px 15px; border: 1px solid #3d2c4b; vertical-align: middle; }
        .admin-table tbody tr { background-color: #1d2a2d; border-bottom: 1px solid #3d2c4b; }
        .admin-table tbody tr:nth-of-type(even) { background-color: #2a3c40; }
        .admin-table tbody tr:hover { background-color: #3c565c; color: #ffffff; }
        .admin-table button, .admin-table input, .admin-table select { padding: 8px; border-radius: 5px; border: 1px solid #3C8F9E; background-color: #0D1B1E; color: #D6C178; cursor: pointer; }
        .admin-table button:hover { background-color: #3C8F9E; color: #fff; }
        .admin-table input[type="date"] { width: auto; }
        .raffle-container { margin-top: 40px; padding: 20px; border: 1px solid #3d2c4b; border-radius: 8px; text-align: center; background-color: #1d2a2d; }
        .raffle-container h2 { border: none; }
        .winner-card { display: none; margin-top: 20px; padding: 20px; background-color: #2a403d; border: 1px solid #D6C178; color: #D6C178; border-radius: 8px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13, 27, 30, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: #1d2a2d; color: #D6C178; padding: 25px; border-radius: 8px; width: 90%; max-width: 800px; border: 1px solid #3d2c4b; box-shadow: 0 5px 25px rgba(0,0,0,0.5); position: relative; }
        .modal-close { position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; color: #ccc; }
        .history-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 10px; border: 1px solid #3d2c4b; text-align: left;}
        .history-table th { background-color: #0A1517; color: #BE93FD; }
        .email-tool { margin-top: 40px; padding: 20px; border: 1px solid #3d2c4b; border-radius: 8px; background-color: #1d2a2d; }
        .email-tool label { display: block; margin-bottom: 5px; }
        .email-tool input, .email-tool textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #3d2c4b; background-color: #0A1517; color: #D6C178; font-size: 1em; }
        .email-tool button { padding: 10px 20px; font-size: 1.1em; cursor: pointer; background-color: #3C8F9E; color: white; border: none; border-radius: 5px; margin-top: 10px; }
        #draw-button {
    padding: 10px 20px;
    font-size: 1.2em;
    cursor: pointer;
    background-color: #3C8F9E; /* Cor de fundo azulada */
    color: white;
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s ease;
}

#draw-button:hover {
    background-color: #4db1c0; /* Cor ao passar o mouse */
}

#draw-button:disabled {
    background-color: #555; /* Cor quando est√° desabilitado (sorteando) */
    cursor: not-allowed;
}
    </style>
</head>

<body>
<div class="sticky-footer-layout">
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="admin-page-container" style="padding: 20px; max-width: 1400px; margin: auto;">
        <h1>Painel do Administrador</h1>

        <div class="dashboard" style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div class="card" style="padding: 20px; border-radius: 8px;">
                <h3>Apoiadores Ativos</h3>
                <p id="total-pagantes" style="font-size: 2em; margin: 0;">Carregando...</p>
            </div>
        </div>

        <h2>Gerenciamento de Usu√°rios</h2>
        <div class="admin-controls">
            <div>
                <label for="status-filter">Filtrar por Status:</label>
                <select id="status-filter">
                    <option value="">Todos</option>
                    <option value="ATIVO">Ativos</option>
                    <option value="EXPIRADO">Expirados</option>
                    <option value="NUNCA_PAGOU">Nunca Pagou</option>
                </select>
            </div>
            <div>
                <label for="search-input">Pesquisar:</label>
                <input type="text" id="search-input" placeholder="Nome ou E-mail...">
            </div>
        </div>

        <table class="admin-table">
            <thead>
            <tr>
                <th><input type="checkbox" id="select-all-users" title="Selecionar Todos"></th>
                <th>ID</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Status</th>
                <th>Vencimento</th>
                <th>√öltimo Valor</th>
                <th>M√©todo</th>
                <th>Pgtos.</th>
                <th>Gerenciar Assinatura</th>
                <th>Papel (Role)</th>
                <th>A√ß√µes</th>
            </tr>
            </thead>
            <tbody id="user-table-body">
            </tbody>
        </table>

        <div class="email-tool">
            <h2>Enviar E-mail para Usu√°rios Selecionados</h2>
            <div style="margin-bottom: 15px;">
                <label for="email-subject">Assunto:</label>
                <input type="text" id="email-subject">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="email-body">Mensagem:</label>
                <textarea id="email-body" rows="8"></textarea>
            </div>
            <button id="send-email-btn">Enviar E-mail</button>
        </div>

        <div class="raffle-container">
            <h2>Sorteio de Apoiadores Ativos</h2>
            <p>Clique no bot√£o abaixo para sortear aleatoriamente um apoiador com assinatura ativa.</p>
            <button id="draw-button">Sortear um Ganhador</button>
            <div id="winner-display" class="winner-card">
                <h3>üéâ O Ganhador √©... üéâ</h3>
                <p style="font-size: 1.5em; font-weight: bold;" id="winner-name"></p>
                <p style="color: #555;" id="winner-email"></p>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<div id="history-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" onclick="closeHistoryModal()">&times;</span>
        <h3 id="history-modal-title">Hist√≥rico de Pagamentos</h3>
        <div id="history-modal-body">
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchDashboardData();
        fetchUsers();

        document.getElementById('status-filter').addEventListener('change', fetchUsers);
        document.getElementById('search-input').addEventListener('keyup', fetchUsers);
        document.getElementById('draw-button').addEventListener('click', drawWinner);

        // Listeners para a ferramenta de e-mail
        document.getElementById('select-all-users').addEventListener('click', toggleSelectAll);
        document.getElementById('send-email-btn').addEventListener('click', sendEmail);
    });

    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard');
            const data = await response.json();
            document.getElementById('total-pagantes').textContent = data.totalPagantesAtivos;
        } catch (error) {
            console.error('Erro ao buscar dados do dashboard:', error);
            document.getElementById('total-pagantes').textContent = 'Erro!';
        }
    }

    async function fetchUsers() {
        const status = document.getElementById('status-filter').value;
        const search = document.getElementById('search-input').value;
        const url = `/api/admin/users?status=${status}&search=${search}`;

        try {
            const response = await fetch(url);
            if (!response.ok) { throw new Error(`Erro na API: ${response.status}`); }
            const users = await response.json();
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';

            if (users.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="13">Nenhum usu√°rio encontrado.</td></tr>';
                 return;
            }

            users.forEach(user => {
                const vencimento = user.acessoValidoAte ? new Date(user.acessoValidoAte).toLocaleDateString('pt-BR') : 'N/A';
                const hoje = new Date().toISOString().split('T')[0];

                let subscriptionControls = '';
                if (user.role !== 'ADMIN') {
                    subscriptionControls = `
                        <input type="date" id="date-input-${user.id}" min="${hoje}" style="padding: 4px;">
                        <button onclick="setSubscriptionDate(${user.id})">Definir Vencimento</button>
                    `;
                }

                const ultimoValor = user.ultimoPagamentoValor ? `R$ ${user.ultimoPagamentoValor.toFixed(2).replace('.', ',')}` : 'N/A';
                const ultimoMetodo = user.ultimoMetodoPagamento ? user.ultimoMetodoPagamento.toUpperCase() : 'N/A';
                const totalPagamentos = user.totalPagamentos > 0 ? user.totalPagamentos : '0';

                const row = `
                    <tr>
                        <td><input type="checkbox" class="user-checkbox" data-user-id="${user.id}"></td>
                        <td><b>${user.id}</b></td>
                        <td>${user.nome}</td>
                        <td>${user.email}</td>
                        <td>${user.telefone || 'N/A'}</td>
                        <td><b>${user.status}</b></td>
                        <td>${vencimento}</td>
                        <td>${ultimoValor}</td>
                        <td>${ultimoMetodo}</td>
                        <td>${totalPagamentos}</td>
                        <td>${subscriptionControls}</td>
                        <td>
                            <select id="role-select-${user.id}">
                                <option value="USER" ${user.role === 'USER' ? 'selected' : ''}>USER</option>
                                <option value="SUBSCRIBER" ${user.role === 'SUBSCRIBER' ? 'selected' : ''}>SUBSCRIBER</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                            </select>
                        </td>
                        <td>
                            <button onclick="updateRole(${user.id})">Salvar Papel</button>
                            <button onclick="showPaymentHistory(${user.id}, '${user.nome}')" style="margin-top: 5px;">Hist√≥rico</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error('Erro ao buscar usu√°rios:', error);
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = `<tr><td colspan="13" style="color: red;">Falha ao carregar usu√°rios.</td></tr>`;
        }
    }

    async function updateRole(userId) {
        const select = document.getElementById(`role-select-${userId}`);
        const newRole = select.value;
        if (!confirm(`Tem certeza que deseja alterar o papel deste usu√°rio para ${newRole}?`)) return;
        try {
            const response = await fetch(`/api/admin/users/${userId}/role`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: newRole })
            });
            if (response.ok) { alert('Papel atualizado!'); fetchUsers(); }
            else { alert('Falha ao atualizar o papel.'); }
        } catch (error) { console.error('Erro:', error); }
    }

    async function setSubscriptionDate(userId) {
        const input = document.getElementById(`date-input-${userId}`);
        const newDate = input.value;
        if (!newDate) {
            alert('Por favor, selecione uma data de vencimento.');
            return;
        }
        if (!confirm(`Tem certeza que deseja definir o vencimento para ${new Date(newDate).toLocaleDateString('pt-BR')}?`)) return;
        try {
            const response = await fetch(`/api/admin/users/${userId}/subscription/set-date`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newExpirationDate: newDate })
            });
            if (response.ok) { alert('Data de vencimento atualizada com sucesso!'); fetchUsers(); }
            else { alert('Falha ao atualizar a data.'); }
        } catch (error) { console.error('Erro ao definir data de vencimento:', error); }
    }

    async function drawWinner() {
        const drawButton = document.getElementById('draw-button');
        const winnerDisplay = document.getElementById('winner-display');
        const winnerName = document.getElementById('winner-name');
        const winnerEmail = document.getElementById('winner-email');
        drawButton.disabled = true;
        drawButton.textContent = 'Sorteando...';
        winnerDisplay.style.display = 'none';
        try {
            const response = await fetch('/api/admin/raffle/draw');
            await new Promise(resolve => setTimeout(resolve, 1500));
            if (response.ok) {
                const winner = await response.json();
                winnerName.textContent = winner.nome;
                winnerEmail.textContent = winner.email;
                winnerDisplay.style.display = 'block';
            } else if (response.status === 404) {
                winnerName.textContent = 'N√£o h√° apoiadores ativos para o sorteio.';
                winnerEmail.textContent = '';
                winnerDisplay.style.display = 'block';
            } else {
                throw new Error('Falha ao realizar o sorteio.');
            }
        } catch (error) {
            console.error('Erro no sorteio:', error);
            alert('Ocorreu um erro ao realizar o sorteio.');
        } finally {
            drawButton.disabled = false;
            drawButton.textContent = 'Sortear Novo Ganhador';
        }
    }

    function closeHistoryModal() {
        document.getElementById('history-modal').style.display = 'none';
    }

    async function showPaymentHistory(userId, userName) {
        const modal = document.getElementById('history-modal');
        const modalTitle = document.getElementById('history-modal-title');
        const modalBody = document.getElementById('history-modal-body');
        modalTitle.textContent = `Hist√≥rico de Pagamentos de: ${userName}`;
        modalBody.innerHTML = '<p>Carregando hist√≥rico...</p>';
        modal.style.display = 'flex';
        try {
            const response = await fetch(`/api/admin/users/${userId}/payments`);
            if (!response.ok) throw new Error('Falha ao buscar o hist√≥rico.');
            const payments = await response.json();
            if (payments.length === 0) {
                modalBody.innerHTML = '<p>Nenhum pagamento encontrado para este usu√°rio.</p>';
                return;
            }
            let tableHtml = `<table class="history-table"><thead><tr><th>Data</th><th>Valor</th><th>M√©todo</th><th>Parcelas</th><th>ID da Transa√ß√£o</th></tr></thead><tbody>`;
            payments.forEach(p => {
                const paymentDate = new Date(p.paymentDate).toLocaleString('pt-BR');
                const amount = `R$ ${p.amount.toFixed(2).replace('.', ',')}`;
                const installments = p.installments || '1';
                tableHtml += `<tr><td>${paymentDate}</td><td>${amount}</td><td>${p.paymentMethodId}</td><td>${installments}</td><td>${p.paymentId}</td></tr>`;
            });
            tableHtml += '</tbody></table>';
            modalBody.innerHTML = tableHtml;
        } catch (error) {
            console.error('Erro ao buscar hist√≥rico:', error);
            modalBody.innerHTML = '<p style="color: red;">N√£o foi poss√≠vel carregar o hist√≥rico.</p>';
        }
    }

    // --- FUN√á√ïES ADICIONADAS PARA A FERRAMENTA DE E-MAIL ---
    function toggleSelectAll(event) {
        const isChecked = event.target.checked;
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }

    async function sendEmail() {
        const subject = document.getElementById('email-subject').value;
        const body = document.getElementById('email-body').value;
        const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
        const userIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.getAttribute('data-user-id')));

        if (userIds.length === 0) {
            alert('Por favor, selecione pelo menos um usu√°rio.');
            return;
        }
        if (!subject || !body) {
            alert('Por favor, preencha o assunto e a mensagem.');
            return;
        }

        if (confirm(`Voc√™ est√° prestes a enviar um e-mail para ${userIds.length} usu√°rio(s). Deseja continuar?`)) {
            const sendButton = document.getElementById('send-email-btn');
            sendButton.disabled = true;
            sendButton.textContent = 'Enviando...';

            try {
                const response = await fetch('/api/admin/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userIds, subject, body })
                });

                if (response.ok) {
                    alert('E-mails enviados com sucesso!');
                    document.getElementById('email-subject').value = '';
                    document.getElementById('email-body').value = '';
                    document.querySelectorAll('.user-checkbox:checked').forEach(cb => cb.checked = false);
                    document.getElementById('select-all-users').checked = false;
                } else {
                    alert('Falha ao enviar os e-mails.');
                }
            } catch (error) {
                console.error('Erro ao enviar e-mails:', error);
                alert('Ocorreu um erro de rede.');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Enviar E-mail';
            }
        }
    }
</script>
</body>
</html>