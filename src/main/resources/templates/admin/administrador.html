<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/head :: common_head('Painel do Administrador')}">
    <style>
        /* Estilos para o sorteio */
        .raffle-container {
            margin-top: 40px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: center;
        }
        .winner-card {
            display: none; /* Come√ßa escondido */
            margin-top: 20px;
            padding: 20px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            border-radius: 8px;
            animation: fadeIn 0.5s;
        }
        .winner-card h3 { margin-top: 0; }
        #draw-button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #draw-button:disabled { background-color: #ccc; cursor: not-allowed; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>

<body>
<div class="sticky-footer-layout">

    <div th:replace="~{fragments/header :: header}"></div>

    <main class="admin-page-container" style="padding: 20px; max-width: 1400px; margin: auto;">
        <h1>Painel do Administrador</h1>

        <div class="dashboard" style="display: flex; gap: 20px; margin-bottom: 30px;">
            <div class="card" style="border: 1px solid #ccc; padding: 20px; border-radius: 8px;">
                <h3>Pagantes Ativos</h3>
                <p id="total-pagantes" style="font-size: 2em; margin: 0;">Carregando...</p>
            </div>
        </div>

        <h2>Gerenciamento de Usu√°rios</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ID</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nome</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Status</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Vencimento em (dias)</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Gerenciar Assinatura</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Papel (Role)</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">A√ß√µes</th>
            </tr>
            </thead>
            <tbody id="user-table-body">
            </tbody>
        </table>

        <div class="raffle-container">
            <h2>Sorteio de Apoiadores Ativos</h2>
            <p>Clique no bot√£o abaixo para sortear aleatoriamente um apoiador com assinatura ativa.</p>
            <button id="draw-button">Sortear um Ganhador</button>

            <div id="winner-display" class="winner-card">
                <h3>üéâ O Ganhador √©... üéâ</h3>
                <p style="font-size: 1.5em; font-weight: bold;" id="winner-name"></p>
                <p style="color: #555;" id="winner-email"></p>
            </div>
        </div>

    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetchDashboardData();
        fetchUsers();

        const drawButton = document.getElementById('draw-button');
        drawButton.addEventListener('click', drawWinner);
    });

    // ... (fun√ß√µes fetchDashboardData, fetchUsers, updateRole, addSubscriptionDays) ...
    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard');
            const data = await response.json();
            document.getElementById('total-pagantes').textContent = data.totalPagantesAtivos;
        } catch (error) {
            console.error('Erro ao buscar dados do dashboard:', error);
            document.getElementById('total-pagantes').textContent = 'Erro!';
        }
    }

    async function fetchUsers() {
        try {
            const response = await fetch('/api/admin/users');
            if (!response.ok) { throw new Error(`Erro na API: ${response.status}`); }
            const users = await response.json();
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = '';

            if (users.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="8">Nenhum usu√°rio encontrado.</td></tr>';
                 return;
            }

            users.forEach(user => {
                const diasParaVencer = user.diasParaVencer !== null ? user.diasParaVencer : 'N/A';

                let subscriptionControls = '';
                if (user.role !== 'ADMIN') {
                    subscriptionControls = `
                        <input type="number" id="days-input-${user.id}" placeholder="Ex: 30" style="width: 60px; padding: 4px;">
                        <button onclick="addSubscriptionDays(${user.id})" style="padding: 5px; cursor: pointer;">Adicionar Dias</button>
                    `;
                }

                const row = `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;"><b>${user.id}</b></td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${user.nome}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${user.email}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;"><b>${user.status}</b></td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${diasParaVencer}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${subscriptionControls}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <select id="role-select-${user.id}" style="padding: 5px;">
                                <option value="USER" ${user.role === 'USER' ? 'selected' : ''}>USER</option>
                                <option value="SUBSCRIBER" ${user.role === 'SUBSCRIBER' ? 'selected' : ''}>SUBSCRIBER</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                            </select>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <button onclick="updateRole(${user.id})" style="padding: 5px 10px; cursor: pointer;">Salvar Papel</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error('Erro ao buscar usu√°rios:', error);
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Falha ao carregar usu√°rios. Verifique o console (F12).</td></tr>`;
        }
    }

    async function updateRole(userId) {
        const select = document.getElementById(`role-select-${userId}`);
        const newRole = select.value;

        try {
            const response = await fetch(`/api/admin/users/${userId}/role`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: newRole })
            });

            if (response.ok) {
                alert('Papel do usu√°rio atualizado com sucesso!');
                fetchUsers();
            } else {
                alert('Falha ao atualizar o papel.');
            }
        } catch (error) {
            console.error('Erro ao atualizar papel:', error);
        }
    }

    async function addSubscriptionDays(userId) {
        const input = document.getElementById(`days-input-${userId}`);
        const daysToAdd = parseInt(input.value, 10);

        if (isNaN(daysToAdd) || daysToAdd <= 0) {
            alert('Por favor, insira um n√∫mero de dias v√°lido.');
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}/subscription`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: daysToAdd })
            });

            if (response.ok) {
                alert(`${daysToAdd} dias adicionados com sucesso!`);
                fetchUsers();
            } else {
                alert('Falha ao adicionar dias. Verifique o console.');
            }
        } catch (error) {
            console.error('Erro ao adicionar dias de assinatura:', error);
        }
    }

    async function drawWinner() {
        const drawButton = document.getElementById('draw-button');
        const winnerDisplay = document.getElementById('winner-display');
        const winnerName = document.getElementById('winner-name');
        const winnerEmail = document.getElementById('winner-email');

        drawButton.disabled = true;
        drawButton.textContent = 'Sorteando...';
        winnerDisplay.style.display = 'none';

        try {
            const response = await fetch('/api/admin/raffle/draw');
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (response.ok) {
                const winner = await response.json();
                winnerName.textContent = winner.nome;
                winnerEmail.textContent = winner.email;
                winnerDisplay.style.display = 'block';
            } else if (response.status === 404) {
                winnerName.textContent = 'N√£o h√° apoiadores ativos para o sorteio.';
                winnerEmail.textContent = '';
                winnerDisplay.style.display = 'block';
            } else {
                throw new Error('Falha ao realizar o sorteio.');
            }
        } catch (error) {
            console.error('Erro no sorteio:', error);
            alert('Ocorreu um erro ao realizar o sorteio. Verifique o console.');
        } finally {
            drawButton.disabled = false;
            drawButton.textContent = 'Sortear Novo Ganhador';
        }
    }
</script>
</body>
</html>